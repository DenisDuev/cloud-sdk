"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[8889],{51355:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>l});var t=s(74848),i=s(28453);const r={id:"kubernetes",title:"Migrate your App from SAP BTP CF to Kubernetes with the SAP Cloud SDK for JavaScript",sidebar_label:"Migrate to Kubernetes",description:"Learn how to migrate your application from SAP BTP Cloud Foundry to Kubernetes with the SAP Cloud SDK for JavaScript",keywords:["sap","cloud","sdk","cloud native","cloud sdk","sap cloud sdk","kubernetes"]},a="How to Migrate a CloudFoundry Application to a Kubernetes Cluster",o={id:"guides/kubernetes",title:"Migrate your App from SAP BTP CF to Kubernetes with the SAP Cloud SDK for JavaScript",description:"Learn how to migrate your application from SAP BTP Cloud Foundry to Kubernetes with the SAP Cloud SDK for JavaScript",source:"@site/docs-js_versioned_docs/version-v1/guides/migrate-sdk-application-from-btp-cf-to-kubernetes.mdx",sourceDirName:"guides",slug:"/guides/kubernetes",permalink:"/cloud-sdk/docs/js/v1/guides/kubernetes",draft:!1,unlisted:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-js_versioned_docs/version-v1/guides/migrate-sdk-application-from-btp-cf-to-kubernetes.mdx",tags:[],version:"v1",frontMatter:{id:"kubernetes",title:"Migrate your App from SAP BTP CF to Kubernetes with the SAP Cloud SDK for JavaScript",sidebar_label:"Migrate to Kubernetes",description:"Learn how to migrate your application from SAP BTP Cloud Foundry to Kubernetes with the SAP Cloud SDK for JavaScript",keywords:["sap","cloud","sdk","cloud native","cloud sdk","sap cloud sdk","kubernetes"]},sidebar:"docsJsSidebar",previous:{title:"Shared ESLint configuration",permalink:"/cloud-sdk/docs/js/v1/features/eslint-configuration"},next:{title:"Migrate to Open Source",permalink:"/cloud-sdk/docs/js/v1/guides/migrate-to-open-source-version-of-cloud-sdk-for-javascript-typescript"}},c={},l=[{value:"Simple PoC Environments",id:"simple-poc-environments",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Create and Bind Services",id:"create-and-bind-services",level:3},{value:"Staging Environments",id:"staging-environments",level:2},{value:"Prerequisites",id:"prerequisites-1",level:3},{value:"Configure the Service Manager",id:"configure-the-service-manager",level:3},{value:"Service Broker Registration",id:"service-broker-registration",level:3},{value:"Create and Bind Services",id:"create-and-bind-services-1",level:3},{value:"Production Environments",id:"production-environments",level:2},{value:"Prerequisites",id:"prerequisites-2",level:3},{value:"Configure Operator",id:"configure-operator",level:3},{value:"Create and Bind Services",id:"create-and-bind-services-2",level:3},{value:"Deploy to Kubernetes",id:"deploy-to-kubernetes",level:2},{value:"Example Application",id:"example-application",level:3},{value:"Dockerfile",id:"dockerfile",level:3},{value:"Deployment YAML",id:"deployment-yaml",level:3},{value:"Deploy and Expose Your Application",id:"deploy-and-expose-your-application",level:3},{value:"Local Connection",id:"local-connection",level:3},{value:"Internet Facing Connection",id:"internet-facing-connection",level:3},{value:"Create a CI/CD Pipeline",id:"create-a-cicd-pipeline",level:2},{value:"Configure TLS and Obtain a Domain in SAP Gardener",id:"configure-tls-and-obtain-a-domain-in-sap-gardener",level:2},{value:"Prerequisites",id:"prerequisites-3",level:3},{value:"Configure Basic Authentication",id:"configure-basic-authentication",level:2},{value:"On-Premise Connectivity",id:"on-premise-connectivity",level:2},{value:"Principal Propagation",id:"principal-propagation",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"how-to-migrate-a-cloudfoundry-application-to-a-kubernetes-cluster",children:"How to Migrate a CloudFoundry Application to a Kubernetes Cluster"})}),"\n",(0,t.jsx)(n.p,{children:"In this how-to, we will show step-by-step what is necessary to migrate an application from CloudFoundry to Kubernetes."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"We decide what kind of environment we are creating.\nIs it a proof-of-concept (PoC), staging, or productive environment?"}),"\n",(0,t.jsx)(n.li,{children:"We prepare and set up our cluster with the sufficient services and service bindings to satisfy the environment's requirements."}),"\n",(0,t.jsx)(n.li,{children:"We adapt our application to deploy to Kubernetes and make sure it can consume bound services from within our Kubernetes cluster."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Select the type of environment you're planning to build and click on it to jump to a corresponding section:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#simple-poc-environments",children:"Simple PoC Environment"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"If you want to create a PoC, this kind of environment will be sufficient for you.\nIt's not recommended for productive use or long-running PoCs."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#staging-environments",children:"Staging Environments"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"For staging environments, we will take a look at a way to create and bind services manually.\nThis is primarily meant to try out different service setups."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"#production-environments",children:"Production Environments"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"For production environments, we will take a look at a way to create and bind services with reproducibility, longevity, and developer simplicity in mind."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"simple-poc-environments",children:"Simple PoC Environments"}),"\n",(0,t.jsx)(n.p,{children:"For a simple PoC, we can create and bind services in CloudFoundry, or preferably even use already existing service bindings."}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/",children:(0,t.jsx)(n.code,{children:"kubectl"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.docker.com/get-docker/",children:(0,t.jsx)(n.code,{children:"docker"})})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"create-and-bind-services",children:"Create and Bind Services"}),"\n",(0,t.jsxs)(n.p,{children:["If you want to create and bind ",(0,t.jsx)(n.em,{children:"new"})," services, you can deploy a ",(0,t.jsx)(n.code,{children:"hello-world"})," app to SAP BTP Cloud Foundry and then bind services to this app.\nOnce that is done, access and copy the JSON representation of the bindings and create a secret in Kubernetes out of them."]}),"\n",(0,t.jsxs)(n.p,{children:["The secret has to be in YAML format like in the example below.\nUse the values from service binding's JSON data to replace the corresponding value in the ",(0,t.jsx)(n.code,{children:"stringData"})," section of the YAML."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: destination-service\ntype: Opaque\nstringData:\n  clientid: <client-id>\n  clientsecret: <client-secret>\n  url: <url>\n  identityzone: <identityzone>\n  tenantid: <tenantid>\n  tenantmode: <tenantmode>\n  verificationkey: <verificationkey>\n  xsappname: <xsappname>\n  uaadomain: <uaadomain>\n  instanceid: <instanceid>\n  uri: <uri>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Once you are done, run ",(0,t.jsx)(n.code,{children:"kubectl apply -f <your-binding>.yml"})," to create the secret in your cluster."]}),"\n",(0,t.jsxs)(n.p,{children:["Now let's take a look at how we adapt our application to deploy it to Kubernetes and how it can consume services from inside of a Kubernetes cluster.\nFor this jump over to the ",(0,t.jsx)(n.a,{href:"#deploy-to-kubernetes",children:"Deploy to Kubernetes"})," section."]}),"\n",(0,t.jsx)(n.h2,{id:"staging-environments",children:"Staging Environments"}),"\n",(0,t.jsx)(n.p,{children:"For a staging environment where you want to try out different services or experiment with service configurations, it is fine to use the following setup."}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites-1",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/Peripli/service-manager-cli",children:(0,t.jsx)(n.code,{children:"smctl"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://svc-cat.io/docs/cli/",children:(0,t.jsx)(n.code,{children:"svcat"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://helm.sh/docs/intro/install/",children:(0,t.jsx)(n.code,{children:"helm"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/",children:(0,t.jsx)(n.code,{children:"kubectl"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.docker.com/get-docker/",children:(0,t.jsx)(n.code,{children:"docker"})})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"configure-the-service-manager",children:"Configure the Service Manager"}),"\n",(0,t.jsxs)(n.p,{children:["First, create a service manager instance in CloudFoundry with the ",(0,t.jsx)(n.code,{children:"subaccount-admin"})," plan."]}),"\n",(0,t.jsx)(n.p,{children:"To be able to create a service manager, you will need sufficient privileges in the SAP BTP Cloud Foundry.\nFollow the steps below to get them:"}),"\n",(0,t.jsxs)(n.p,{children:["In the SAP BTP cockpit, navigate to your ",(0,t.jsx)(n.code,{children:"subaccount"})," and choose ",(0,t.jsx)(n.strong,{children:"Security \u2192 Trust Configuration \u2192 SAP ID Service"}),".\nAssign the ",(0,t.jsx)(n.code,{children:"Subaccount Service Administrator"})," role collection to your email address."]}),"\n",(0,t.jsxs)(n.p,{children:["Next, you need to login to the service manager control, also called ",(0,t.jsx)(n.code,{children:"smctl"}),", and register your cluster"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"smctl login -a https://service-manager.<cf-api-end-point> --param subdomain=<your-cf-subdomain>\nsmctl register-platform <name-you-want-to-give-the-cluster> kubernetes > service-manager-credentials.txt\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"service-manager-credentials.txt"})," contains sensitive data, keep it in a safe place.\nYou will need the ",(0,t.jsx)(n.code,{children:"username"})," and ",(0,t.jsx)(n.code,{children:"password"})," later on."]}),"\n",(0,t.jsx)(n.h3,{id:"service-broker-registration",children:"Service Broker Registration"}),"\n",(0,t.jsxs)(n.p,{children:["To make the services available in the Kubernetes cluster, we need to register a service broker into the Service Catalog of our Kubernetes cluster.\nIn SAP BTP Cloud Foundry the role of a service broker is fulfilled by the ",(0,t.jsx)(n.code,{children:"Service Manager"}),".\nRegister it using the Service Catalog CLI, ",(0,t.jsx)(n.code,{children:"svcat"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["To access the ",(0,t.jsx)(n.code,{children:"Service Manager"})," on SAP BTP CF, we need to install the ",(0,t.jsx)(n.code,{children:"service-broker-proxy"})," in our Kubernetes (K8s) cluster.\nHere's how you do it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm repo add peripli 'https://peripli.github.io'\n\nkubectl create namespace service-broker-proxy\n\nhelm install service-broker-proxy peripli/service-broker-proxy-k8s \\\n  --namespace service-broker-proxy \\\n  --set image.tag=v0.3.2 \\\n  --set config.sm.url=<service-manager-url> \\\n  --set sm.user=<service-manager-user> \\\n  --set sm.password=<service-manager-password>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["After installing the proxy you have to wait a few seconds until it is fully operational.\nOnce the proxy is up, try running ",(0,t.jsx)(n.code,{children:"svcat marketplace"}),", all the services available on SAP BTP CF should now be listed."]}),"\n",(0,t.jsx)(n.h3,{id:"create-and-bind-services-1",children:"Create and Bind Services"}),"\n",(0,t.jsx)(n.p,{children:"Now we can create service instances with the service catalog.\nLet's create a destination service instance first."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"svcat provision destination-service --class destination --plan lite\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["Notice how ",(0,t.jsx)(n.code,{children:"destination-service"})," is just the name we give to this particular service instance, it could be anything."]})}),"\n",(0,t.jsx)(n.p,{children:"Now we could also create an XSUAA service instance."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"svcat provision xsuaa-service --class xsuaa --plan broker\n"})}),"\n",(0,t.jsx)(n.p,{children:"Finally, we just need to bind the services to make them available to our application."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"svcat bind destination-service\nsvcat bind xsuaa-service\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Now let's take a look at how we adapt our application to deploy it to Kubernetes and make it consume services from inside of a Kubernetes cluster.\nFor this jump over to the ",(0,t.jsx)(n.a,{href:"#deploy-to-kubernetes",children:"Deploy to Kubernetes"})," section."]}),"\n",(0,t.jsx)(n.h2,{id:"production-environments",children:"Production Environments"}),"\n",(0,t.jsx)(n.p,{children:"For production environments, you need a reliable and reproducible way of configuring which services are running in your cluster.\nTo achieve that you can leverage the service operator.\nWith the service operator, all services are deployed via YAML files.\nIt makes services management a lot easier, scalable, and protected from errors in a long-term production environment."}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites-2",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://helm.sh/docs/intro/install/",children:(0,t.jsx)(n.code,{children:"helm"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/",children:(0,t.jsx)(n.code,{children:"kubectl"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.docker.com/get-docker/",children:(0,t.jsx)(n.code,{children:"docker"})})}),"\n",(0,t.jsxs)(n.li,{children:["Kubernetes Cluster with a LoadBalancer enabled, we recommend using ",(0,t.jsx)(n.a,{href:"https://dashboard.garden.canary.k8s.ondemand.com/",children:"Gardener"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"configure-operator",children:"Configure Operator"}),"\n",(0,t.jsxs)(n.p,{children:["To use the service operator, you'll need to set up at least basic TLS with a self-signed issuer certificate.\nRun the command below to install the ",(0,t.jsx)(n.code,{children:"cert-manager"})," to aid your TLS setup."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.4.0/cert-manager.yaml\n"})}),"\n",(0,t.jsxs)(n.p,{children:["To deploy the ",(0,t.jsx)(n.code,{children:"cert-manager"})," into your cluster, install the ",(0,t.jsx)(n.code,{children:"cert-manager"})," ",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/",children:"CRDs"})," with"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.4.0/cert-manager.crds.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Finally, add a self-signed certificate issuer to your cluster.\nIt can be done by adding the following YAML configuration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: selfsigned-issuer\nspec:\n  selfSigned: {}\n---\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: selfsigned-cluster-issuer\nspec:\n  selfSigned: {}\n"})}),"\n",(0,t.jsx)(n.p,{children:"After you deployed the self-signed certificate issuer, we can start steps to deploy a service operator instance."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["First, we create a service manager instance in SAP BTP CF with the ",(0,t.jsx)(n.code,{children:"service-operator-access"})," plan."]}),"\n",(0,t.jsxs)(n.li,{children:["After creating an instance we also need to bind it.\nThe binding ",(0,t.jsx)(n.code,{children:"JSON"})," should look similar to this:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-JSON",children:' {\n     "clientid": "<clientid>",\n     "clientsecret": "<clientsecret>",\n     "url": "<url>",\n     "xsappname": "<xsappname>",\n     "sm_url": "<sm_url>"\n }\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Once you have the data from the service manager's binding, provide it to ",(0,t.jsx)(n.code,{children:"helm"})," and deploy the service operator.\nHelm is a package manager for Kubernetes."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm upgrade --install sapbtp-operator https://github.com/SAP/sap-btp-service-operator/releases/download/<release>/sapbtp-operator-<release>.tgz \\\n    --create-namespace \\\n    --namespace=sapbtp-operator \\\n    --set manager.secret.clientid=<clientid> \\\n    --set manager.secret.clientsecret=<clientsecret> \\\n    --set manager.secret.url=<sm_url> \\\n    --set manager.secret.tokenurl=<url>\n"})}),"\n",(0,t.jsx)(n.h3,{id:"create-and-bind-services-2",children:"Create and Bind Services"}),"\n",(0,t.jsx)(n.p,{children:"Now that the service operator is running in your cluster, you can create services just like you would do in SAP BTP CF, but instead of the SAP BTP cockpit, you'll use YAML service definitions."}),"\n",(0,t.jsxs)(n.p,{children:["Here is an example of creating and binding a ",(0,t.jsx)(n.strong,{children:"Destination"})," service:"]}),"\n",(0,t.jsx)(n.p,{children:"Creating an instance:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: services.cloud.sap.com/v1alpha1\nkind: ServiceInstance\nmetadata:\n  name: operator-destination-service\nspec:\n  serviceOfferingName: destination\n  servicePlanName: lite\n"})}),"\n",(0,t.jsx)(n.p,{children:"Binding the instance:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: services.cloud.sap.com/v1alpha1\nkind: ServiceBinding\nmetadata:\n  name: operator-destination-service\nspec:\n  serviceInstanceName: operator-destination-service\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["Notice that the ",(0,t.jsx)(n.code,{children:"metadata -> name"})," property can be anything you want.\nIn our case, it's ",(0,t.jsx)(n.code,{children:"operator-destination-service"}),".\nMake sure it matches exactly to the ",(0,t.jsx)(n.code,{children:"spec -> serviceInstanceName"})," field in the binding."]})}),"\n",(0,t.jsx)(n.p,{children:"Follow this pattern for all services your application needs to create and bind."}),"\n",(0,t.jsxs)(n.p,{children:["Now let's take a look at how we adapt our application to deploy it to Kubernetes and make it consume services from inside of a Kubernetes cluster.\nFor this jump over to the ",(0,t.jsx)(n.a,{href:"#deploy-to-kubernetes",children:"Deploy to Kubernetes"})," section."]}),"\n",(0,t.jsx)(n.h2,{id:"deploy-to-kubernetes",children:"Deploy to Kubernetes"}),"\n",(0,t.jsx)(n.p,{children:"To deploy an application to Kubernetes we have to take a look at two things:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"How do we deploy our application to Kubernetes."}),"\n",(0,t.jsx)(n.li,{children:"How do we consume the services in our application from within Kubernetes.\nWe'll use our example application to demonstrate this."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"example-application",children:"Example Application"}),"\n",(0,t.jsxs)(n.p,{children:["Here's the example application we're going to use: ",(0,t.jsx)(n.a,{href:"https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/k8s-sample-application",children:"Kubernetes app"}),".\nTo figure out what has to be migrated we just have to take a look at the ",(0,t.jsx)(n.code,{children:"manifest.yml"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"applications:\n  - name: k8s-e2e-app\n    path: deployment/\n    buildpacks:\n      - nodejs_buildpack\n    memory: 256M\n    command: npm run start:prod\n    random-route: true\n    services:\n      - destination-service\n      - xsuaa-service\n"})}),"\n",(0,t.jsx)(n.p,{children:"From this we see that:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"We need a node environment"}),"\n",(0,t.jsx)(n.li,{children:"We need 256MB of memory"}),"\n",(0,t.jsx)(n.li,{children:"How to start the app"}),"\n",(0,t.jsx)(n.li,{children:"The services we need to create and bind"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This information is important in the following steps."}),"\n",(0,t.jsx)(n.h3,{id:"dockerfile",children:"Dockerfile"}),"\n",(0,t.jsxs)(n.p,{children:["Kubernetes ",(0,t.jsx)(n.code,{children:"Pods"})," are running container images.\nWe'll need a ",(0,t.jsx)(n.code,{children:"Dockerfile"})," defining a container for our example application.\nThen it can be deployed to one or more Kubernetes ",(0,t.jsx)(n.code,{children:"Pods"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-Dockerfile",children:'FROM node:12-alpine\n\nWORKDIR /workdir\n\nCOPY /deployment /workdir\n\nRUN ["npm", "install", "--unsafe-perm"]\n\nEXPOSE 3000\nCMD ["npm", "run", "start:prod"]\n'})}),"\n",(0,t.jsxs)(n.p,{children:["You can see that our ",(0,t.jsx)(n.code,{children:"Dockerfile"})," reflects the information from the ",(0,t.jsx)(n.code,{children:"manifest.yml"}),".\nWe specify ",(0,t.jsx)(n.code,{children:"Node"})," as an environment, ",(0,t.jsx)(n.code,{children:"/deployment"})," as a path to copy our application to, and the command to run when the container image is fully loaded."]}),"\n",(0,t.jsx)(n.h3,{id:"deployment-yaml",children:"Deployment YAML"}),"\n",(0,t.jsxs)(n.p,{children:["Next, we need to create a ",(0,t.jsx)(n.code,{children:"deployment.yml"})," that contains the following data:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"resources definition our application needs"}),"\n",(0,t.jsx)(n.li,{children:"container image, as well as registry secrets (in case your image was pushed to a private repository)"}),"\n",(0,t.jsx)(n.li,{children:"service bindings we previously created"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: sdkjs-e2e-deployment\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: sdkjs-e2e\n  template:\n    metadata:\n      labels:\n        app: sdkjs-e2e\n    spec:\n      containers:\n        - name: sdkjs-e2e\n          image: docker-cloudsdk.docker.repositories.sap.ondemand.com/k8s-e2e-app:latest\n          resources:\n            requests:\n              memory: '256Mi'\n              cpu: '500m'\n            limits:\n              memory: '512Mi'\n              cpu: '1000m'\n          ports:\n            - containerPort: 3000\n          volumeMounts:\n            - name: destination-volume\n              mountPath: '/etc/secrets/sapcp/destination/operator-destination-service'\n              readOnly: true\n            - name: xsuaa-volume\n              mountPath: '/etc/secrets/sapcp/xsuaa/operator-xsuaa-service'\n              readOnly: true\n      imagePullSecrets:\n        - name: regcred\n      volumes:\n        - name: destination-volume\n          secret:\n            secretName: operator-destination-service\n        - name: xsuaa-volume\n          secret:\n            secretName: operator-xsuaa-service\n"})}),"\n",(0,t.jsxs)(n.p,{children:["From the ",(0,t.jsx)(n.code,{children:"manifest.yml"})," we know that the app roughly needed 256MB of RAM on SAP BTP CF, we can use it as guidance for Kubernetes by adding it to the ",(0,t.jsx)(n.code,{children:"requests"})," field.\nWith Kubernetes, we can allow the resources to scale by also providing the ",(0,t.jsx)(n.code,{children:"limits"})," field which in our case allows extending RAM up to 512MB."]}),"\n",(0,t.jsxs)(n.p,{children:["Notice that we used ",(0,t.jsx)(n.code,{children:"imagePullSecrets"}),", which is using the ",(0,t.jsx)(n.code,{children:"regcred"})," secret, the ",(0,t.jsx)(n.code,{children:"regcred"})," secret contains our own registry credentials that we previously bound as a secret.\nYou can do this either by writing a ",(0,t.jsx)(n.code,{children:"secret.yml"})," or directly in the CLI (though this will be in your ",(0,t.jsx)(n.code,{children:".bashrc"}),") like this:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl create secret docker-registry regcred \\\n  --docker-username=<name \\\n  --docker-password=<password> \\\n  --docker-email=<email>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Finally, notice how we mount every service which we also had in the ",(0,t.jsx)(n.code,{children:"manifest.yml"}),", in this case, a ",(0,t.jsx)(n.strong,{children:"Destination"})," service and an ",(0,t.jsx)(n.strong,{children:"XSUAA"})," service.\nTo do this we use ",(0,t.jsx)(n.code,{children:"volumes"})," and ",(0,t.jsx)(n.code,{children:"volumeMounts"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["The structure for ",(0,t.jsx)(n.code,{children:"volumes"})," is:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"volumes:\n  - name: <some-volume-name>\n    secret:\n      secretName: <name-of-service-binding>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Here we make a secret, in this case, a service binding, available as a volume.\nNext, we need to mount this secret at a specific path for it to be usable by our application.\nFor this, we follow a path convention provided by the ",(0,t.jsx)(n.a,{href:"https://www.npmjs.com/package/@sap/xsenv",children:"xsenv"})," library."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"volumeMounts:\n  - name: <volume-name>\n    mountPath: '/etc/secrets/sapcp/<service>/<service-name>'\n    readOnly: true\n"})}),"\n",(0,t.jsx)(n.h3,{id:"deploy-and-expose-your-application",children:"Deploy and Expose Your Application"}),"\n",(0,t.jsx)(n.p,{children:"To deploy your application, run:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f deployment.yml"})}),"\n",(0,t.jsx)(n.p,{children:"To access your application you have two options, either you expose it to the internet directly or port-forward to your local machine."}),"\n",(0,t.jsx)(n.h3,{id:"local-connection",children:"Local Connection"}),"\n",(0,t.jsxs)(n.p,{children:["Run ",(0,t.jsx)(n.code,{children:"kubectl port-forward deployment <your-deployment> :3000"})," on your local machine to enable port forwarding.\nWe use port 3000 because our application is listening on it.\nKubernetes will find any available port on your local machine and forward port 3000 of your deployment to it.\nThen you'll be able to make a call to your application via a provided link."]}),"\n",(0,t.jsx)(n.h3,{id:"internet-facing-connection",children:"Internet Facing Connection"}),"\n",(0,t.jsxs)(n.p,{children:["Run the command below to expose your application to the internet.\nIt will use your cluster's IP address and port your application listens on.\nExposing an application this way is good only for testing.\n",(0,t.jsx)(n.strong,{children:"Don't use it in production."})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:'kubectl expose deployment <deployment-name> --type="LoadBalancer"'})}),"\n",(0,t.jsxs)(n.p,{children:["If you want to expose your cluster under Domain name with TLS and/or basic authentication check out the ",(0,t.jsx)(n.a,{href:"#configure-tls-and-obtain-a-domain-in-sap-gardener",children:"Configure TLS and obtain a Domain in SAP Gardener"})," part for an ",(0,t.jsx)(n.code,{children:"SAP Gardener"})," setup or the official Kubernetes ",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/",children:"documentation"})," for a general setup."]}),"\n",(0,t.jsx)(n.h2,{id:"create-a-cicd-pipeline",children:"Create a CI/CD Pipeline"}),"\n",(0,t.jsx)(n.p,{children:"You can create a simple CI/CD pipeline with GitHub Actions or change your existing pipeline.\nTo automatically deploy your application into the K8s cluster, two things are needed:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Automatic build and deployment of the container image into the container repository"}),"\n",(0,t.jsx)(n.li,{children:"Automatic re-start of the Kubernetes deployment"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Step (1) can be achieved by building and pushing the container image with a technical user.\nFor Step (2) we need a technical user that is entitled to manage the cluster deployment."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/",children:"Create a service account"})," in your cluster"]}),"\n",(0,t.jsxs)(n.li,{children:["Bind the ",(0,t.jsx)(n.code,{children:"cluster-admin"})," ClusterRole to the service account.\nAlternative, create a more strict role."]}),"\n",(0,t.jsxs)(n.li,{children:["Obtain the ",(0,t.jsx)(n.em,{children:"token"})," and ",(0,t.jsx)(n.em,{children:"CA certificate"})," from the secret that is automatically created for that service account"]}),"\n",(0,t.jsxs)(n.li,{children:["Obtain the cluster API endpoint via ",(0,t.jsx)(n.code,{children:"kubectl cluster-info"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"You can now use the service account in your automation to connect to the cluster:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl config set-cluster gardener --server=<your-cluster-api-endpoint>\nkubectl config set-context gardener --cluster=gardener\nkubectl config use-context gardener\nkubectl config view\nkubectl --token=${{ secrets.KUBERNETES_SERVICE_TOKEN }} --certificate-authority <path/to/ca.cert> cluster-info\n"})}),"\n",(0,t.jsx)(n.p,{children:"After completing the previous steps, run the command below.\nIt shutdowns all the Pods to restart them."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl --token=${{ secrets.KUBERNETES_SERVICE_TOKEN }} --certificate-authority <path/to/ca.cert> rollout restart deployment/<your-deployment-name>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["If your deployment is configured with ",(0,t.jsx)(n.code,{children:"ImagePullStrategy: Always"})," this will pull the updated image and use it."]}),"\n",(0,t.jsx)(n.h2,{id:"configure-tls-and-obtain-a-domain-in-sap-gardener",children:"Configure TLS and Obtain a Domain in SAP Gardener"}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites-3",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Enable the NGINX Ingress add-on for your ",(0,t.jsx)(n.code,{children:"SAP Gardener"})," cluster"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The fastest way to enable TLS and obtain a domain for your application is to create a service, which contains your deployment, and an Ingress, which handles the routing.\nIn ",(0,t.jsx)(n.code,{children:"SAP Gardener"})," you can already specify your desired domain and the TLS will be managed for you, more on that later."]}),"\n",(0,t.jsx)(n.p,{children:"Create a service that contains your deployment and the port you want to expose as in example below:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: sdkjs-e2e-svc\nspec:\n  selector:\n    app: sdkjs-e2e\n  ports:\n    - port: 8080\n      targetPort: 3000\n"})}),"\n",(0,t.jsx)(n.p,{children:"Next, check your shoot-cluster YAML for the currently configured DNS.\nThe shoot-cluster YAML should be located in your Gardener project's dashboard, under the YAML tab.\nIt should be a field that looks like this:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spec:\n  dns:\n    domain: cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Since you have the NGINX Ingress enabled, all your domains have to follow the pattern ",(0,t.jsx)(n.code,{children:"*.ingress.<your-dns>"}),", for example"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This is how your ",(0,t.jsx)(n.code,{children:"Ingress"})," file should look like:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: sdkjs-e2e-ingress\n  annotations:\n    cert.gardener.cloud/purpose: managed\nspec:\n  tls:\n    - hosts:\n        - cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      secretName: secret-tls\n  rules:\n    - host: e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: sdkjs-e2e-svc\n                port:\n                  number: 8080\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Notice how our ",(0,t.jsx)(n.code,{children:"Ingress"})," uses the ",(0,t.jsx)(n.code,{children:"SAP Gardener"})," annotations, which is important so that ",(0,t.jsx)(n.code,{children:"SAP Gardener"})," manages our TLS."]}),"\n",(0,t.jsxs)(n.p,{children:["Next, you can see in the ",(0,t.jsx)(n.code,{children:"spec.tls.hosts"})," part that we expose 2 domains.\nThe first one is our default domain, it's limited to a maximum of 64 characters.\nOther domains can be any size, but should follow the ",(0,t.jsx)(n.code,{children:"Ingress"})," pattern."]}),"\n",(0,t.jsxs)(n.p,{children:["Notice we specified ",(0,t.jsx)(n.code,{children:"secretName: secret-tls"}),", in this secret.\nAll TLS certificates will be saved by ",(0,t.jsx)(n.code,{children:"SAP Gardener"}),".\nFinally look at how we serve our service at the root of our subdomain, this way the service is exposed to the internet."]}),"\n",(0,t.jsx)(n.p,{children:"After a short delay, you should be able to access the mentioned domains via a valid TLS."}),"\n",(0,t.jsx)(n.h2,{id:"configure-basic-authentication",children:"Configure Basic Authentication"}),"\n",(0,t.jsxs)(n.p,{children:["In case your application doesn't have built-in authentication, you can add basic authentication in front of your ",(0,t.jsx)(n.code,{children:"Ingress"})," with the following steps:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Create a ",(0,t.jsx)(n.code,{children:"htpasswd"})," file"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"htpasswd -c auth username\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"Create a secret out of this file"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl create secret generic <secret-name> --from-file=auth\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Add annotations to your ",(0,t.jsx)(n.code,{children:"Ingress"}),".\nFor our example, it should look like the following:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: sdkjs-e2e-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/auth-type: basic\n    nginx.ingress.kubernetes.io/auth-secret: ingress-gate-auth\n    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - This services is protected.'\n    cert.gardener.cloud/purpose: managed\nspec:\n  tls:\n    - hosts:\n        - cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      secretName: secret-tls\n  rules:\n    - host: e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: sdkjs-e2e-svc\n                port:\n                  number: 8080\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Notice how ",(0,t.jsx)(n.code,{children:"ingress-gate-auth"})," is the name of the secret containing our password.\nThe text following the annotation ",(0,t.jsx)(n.code,{children:"nginx.ingress.kubernetes.io/auth-realm:"})," contains a message, which is prompted when asking for credentials for the basic authentication.\nYour basic authentication should now work.\nAccessing any path should open an authentication window."]}),"\n",(0,t.jsx)(n.h2,{id:"on-premise-connectivity",children:"On-Premise Connectivity"}),"\n",(0,t.jsx)(n.admonition,{type:"danger",children:(0,t.jsx)(n.p,{children:"On-Premise connectivity in Kubernetes is currently not available for external SAP customers.\nThis might be changed in the near future.\nWe'll be updating our documentation accordingly."})}),"\n",(0,t.jsxs)(n.p,{children:["To connect to On-Premise systems inside a Kubernetes cluster, you need to use the ",(0,t.jsx)(n.code,{children:"Connectivity Proxy"}),".\nThe following guide will show you what has to be done to create and use it."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["You need to create a route for the ",(0,t.jsx)(n.code,{children:"Connectivity Proxy"})," to use.\nThis route needs to have TLS enabled.\nTo enable TLS on ",(0,t.jsx)(n.code,{children:"SAP Gardener"}),", refer to ",(0,t.jsx)(n.a,{href:"#configure-tls-and-obtain-a-domain-in-sap-gardener",children:"Configure TLS and Obtain a Domain in SAP Gardener"})," section.\nIf your cluster is not backed by ",(0,t.jsx)(n.code,{children:"SAP Gardener"}),", refer to the official ",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/",children:"Kubernetes documentation"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Here is an example where we add our custom domain ",(0,t.jsx)(n.code,{children:"connectivitytunnel.*"})," to our TLS section, in ",(0,t.jsx)(n.code,{children:"SAP Gardener"}),".\nThis creates a certificate for this domain automatically."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spec:\n  tls:\n    - hosts:\n        - cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - connectivitytunnel.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      secretName: secret-tls\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["Now we need to add our CA certificate to the JVM trust store of the ",(0,t.jsx)(n.code,{children:"Cloud Connector"}),".\nThe CA certificate is stored in the TLS secret, in our case, we named it ",(0,t.jsx)(n.code,{children:"secret-tls"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To access the information inside a secret, use the following code snippet:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'kubectl get secret <secret-name> -o go-template=\'\n{{range $k,$v := .data}}{{printf "%s: " $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{"\\n"}}{{end}}\'\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Inside the secret should be a block prefixed with ",(0,t.jsx)(n.code,{children:"ca.crt"}),", copy this certificate into a file and then follow ",(0,t.jsx)(n.a,{href:"https://connect2id.com/blog/importing-ca-root-cert-into-jvm-trust-store",children:"this guide"})," to add it to the JVM trust store of your ",(0,t.jsx)(n.code,{children:"Cloud Connector"}),"."]}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["Create and bind the connectivity service with the ",(0,t.jsx)(n.code,{children:"connectivty_proxy"})," plan.\nWe already explained how to do it above.\nAdditionally, to bind the secret represented by Kubernetes native YAML format, you need to convert it to a JSON to be consumable by the connectivity proxy.\nIf you use the PoC environment, save the binding as a secret, use the example below to guide you.\nOtherwise, you need to retrieve the binding first and then convert it to ",(0,t.jsx)(n.code,{children:"JSON"})," before saving it as a secret.\nFor that you need to retrieve the secret's content first, you can use the previous code snippet we used to retrieve the values of a secret for that."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Then save the ",(0,t.jsx)(n.code,{children:"JSON"})," as a secret, here is an example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Secret\nmetadata:\n  name: connectivity-proxy-service-key\ntype: Opaque\nstringData:\n  connectivity_key: \'{\n    "clientid": "<client-id>",\n    "clientsecret": "<clientsecret>",\n    "xsappname": "<xsappname>",\n    "connectivity_service": {\n        "CAs_path":"/api/v1/CAs",\n        "CAs_signing_path":"/api/v1/CAs/signing",\n        "api_path":"/api/v1",\n        "tunnel_path":"/api/v1/tunnel",\n        "url":"https://connectivity.cf.sap.hana.ondemand.com"\n    },\n    "subaccount_id": "<subaccount_id",\n    "subaccount_subdomain": "<subaccount_subdomain>",\n    "token_service_domain": "<token_service_domain">",\n    "token_service_url": "<token_service_url>",\n    "token_service_url_pattern": "https://{tenant}.authentication.sap.hana.ondemand.com/oauth/token",\n    "token_service_url_pattern_tenant_key": "subaccount_subdomain"\n}\'\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["Note that we used the ",(0,t.jsx)(n.code,{children:"stringData"})," field type instead of the default ",(0,t.jsx)(n.code,{children:"data"})," field type to benefit from automatic base64 encoding, instead of doing it ourselves.\nThis is a requirement of the connectivity proxy since it can't consume the data of the secret in YAML format ",(0,t.jsx)(n.em,{children:"yet"}),"."]})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsx)(n.li,{children:"Now we need to download the CA certificate of the connectivity service and create a secret containing:"}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"The CA certificate of the connectivity service"}),"\n",(0,t.jsx)(n.li,{children:"Our private key"}),"\n",(0,t.jsx)(n.li,{children:"Our public certificate"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The private key and public certificate are also stored in our TLS secret, use the previous code snippet to retrieve it from the secret and save them in separate files.\nFinally, download the CA certificate with the following line:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"curl https://connectivity.cf.sap.hana.ondemand.com/api/v1/CAs/signing -o connectivity_ca.crt\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now you can create the secret with this command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl create secret generic connectivity-tls --from-file=ca.crt=<your-connectivity-ca.crt> --from-file=tls.key=<your-private.key> --from-file=tls.crt=<your-public.crt> --namespace default\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsxs)(n.li,{children:["Create a secret that contains credentials to access the docker image which the ",(0,t.jsx)(n.code,{children:"Connectivity Proxy"})," is using."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The image is located here: ",(0,t.jsx)(n.code,{children:"deploy-releases.docker.repositories.sap.ondemand.com"})]}),"\n",(0,t.jsx)(n.p,{children:"To create the registry secret, use the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl create secret docker-registry <your-registry-secret> \\\n  --docker-username=<your-username> \\\n  --docker-password=<your-password> \\\n  --docker-server=deploy-releases.docker.repositories.sap.ondemand.com\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"6",children:["\n",(0,t.jsxs)(n.li,{children:["Create a ",(0,t.jsx)(n.code,{children:"values.yaml"})," file containing the configuration that suits your desired operational mode of the connectivity proxy, for the available operational modes refer to the ",(0,t.jsx)(n.a,{href:"https://help.sap.com/viewer/cca91383641e40ffbe03bdc78f00f681/Cloud/en-US/f3c1ef45db77489c8d039acc9530358f.html",children:"documentation"}),".\nFor the specific content of the configuration refer to the ",(0,t.jsx)(n.a,{href:"https://help.sap.com/viewer/cca91383641e40ffbe03bdc78f00f681/Cloud/en-US/eaa8204fc7484df984b3c321624827ff.html",children:"configuration guide"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Here is an example for the ",(0,t.jsx)(n.code,{children:"Single tenant in a trusted environment"})," mode:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"deployment:\n  replicaCount: 1\n  image:\n    pullSecret: 'proxy-secret'\ningress:\n  tls:\n    secretName: 'connectivity-tls'\nconfig:\n  integration:\n    auditlog:\n      mode: console\n    connectivityService:\n      serviceCredentialsKey: 'connectivity_key'\n  tenantMode: dedicated\n  subaccountId: '<subaccount-id>'\n  subaccountSubdomain: '<subaccount-domain>'\n  servers:\n    businessDataTunnel:\n      externalHost: 'connectivitytunnel.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com'\n      externalPort: 443\n    proxy:\n      rfcAndLdap:\n        enabled: true\n        enableProxyAuthorization: false\n      http:\n        enabled: true\n        enableProxyAuthorization: false\n        enableRequestTracing: true\n      socks5:\n        enableProxyAuthorization: false\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"7",children:["\n",(0,t.jsxs)(n.li,{children:["For your application to reach On-Premise destinations, it needs to provide the proxy settings and the token URL.\nCurrently, you have to add them manually to the ",(0,t.jsx)(n.code,{children:"secret"})," containing the service binding."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To do this, use the following code snippet:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl edit secret <binding-name>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Now you have to add the fields ",(0,t.jsx)(n.code,{children:"onpremise_proxy_host"})," and ",(0,t.jsx)(n.code,{children:"onpremise_proxy_port"})," and ",(0,t.jsx)(n.code,{children:"url"}),".\nThe host has the pattern ",(0,t.jsx)(n.code,{children:"connectivity-proxy.<namespace>"})," which is in our case ",(0,t.jsx)(n.code,{children:"connectivity-proxy.default"}),".\nThe default port is ",(0,t.jsx)(n.code,{children:"20003"}),".\nThe ",(0,t.jsx)(n.code,{children:"url"})," field should contain the same value as ",(0,t.jsx)(n.code,{children:"token_service_url"}),".\nBe aware that the values have to be encoded in base64, for example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"onpremise_proxy_host: Y29ubmVjdGl2aXR5LXByb3h5LmRlZmF1bHQ=\nonpremise_proxy_port: MjAwMDM=\nurl: aHR0cHM6Ly9teS1hcGkuYXV0aGVudGljYXRpb24uc2FwLmhhbmEub25kZW1hbmQuY29tCg==\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"8",children:["\n",(0,t.jsxs)(n.li,{children:["Finally, add the binding to your ",(0,t.jsx)(n.code,{children:"deployment.yml"}),", the same way you would add any other binding."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"principal-propagation",children:"Principal Propagation"}),"\n",(0,t.jsx)(n.p,{children:"You can use the Application Router also known as approuter to propagate a principal in Kubernetes and achieve multi-tenancy.\nIt works in a similar fashion to SAP BTP CloudFoundry."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["You need an XSUAA instance that can redirect to a Kubernetes URI.\nFor this the parameter ",(0,t.jsx)(n.code,{children:"redirect-uris"})," is important, however, if you use one parameter while creating a service, you have to use all of them."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Below is an example using the SAP BTP Operator, to create an XSUAA with a very generic rule specifying the allowed URI with wildcards ",(0,t.jsx)(n.code,{children:"https://*/**"}),".\nFor your application, it is recommended to point directly at your specific URI."]}),"\n",(0,t.jsxs)(n.p,{children:["If you are not using the SAP BTP Operator, you still have to provide the same parameters but in a different format.\nIn CloudFoundry, for instance, you have to provide these parameters in ",(0,t.jsx)(n.code,{children:"JSON"})," format."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: services.cloud.sap.com/v1alpha1\nkind: ServiceInstance\nmetadata:\n  name: operator-xsuaa-service\nspec:\n  serviceOfferingName: xsuaa\n  servicePlanName: application\n  parameters:\n    xsappname: kubernetes-xsuaa\n    tenant-mode: dedicated\n    scopes:\n      - name: '$XSAPPNAME.Callback'\n        description: 'With this scope set, the callbacks for tenant onboarding, offboarding and getDependencies can be called.'\n        grant-as-authority-to-apps:\n          - $XSAPPNAME(application,sap-provisioning,tenant-onboarding)\n    role-templates:\n      - name: TOKEN_EXCHANGE\n        description: Token exchange\n        scope-references:\n          - uaa.user\n      - name: 'MultitenancyCallbackRoleTemplate'\n        description: 'Call callback-services of applications'\n        scope-references:\n          - '$XSAPPNAME.Callback'\n    oauth2-configuration:\n      grant-types:\n        - authorization_code\n        - client_credentials\n        - password\n        - refresh_token\n        - urn:ietf:params:oauth:grant-type:saml2-bearer\n        - user_token\n        - client_x509\n        - urn:ietf:params:oauth:grant-type:jwt-bearer\n      redirect-uris:\n        - https://*/**\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Package the ",(0,t.jsx)(n.code,{children:"AppRouter"})," as a ",(0,t.jsx)(n.code,{children:"Dockerimage"})," so that it can run in Kubernetes, refer to the ",(0,t.jsx)(n.a,{href:"https://blogs.sap.com/2020/04/03/sap-application-router/",children:"documentation"})," for configuration details."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["After creating a container image, create a ",(0,t.jsx)(n.code,{children:"Deployment"})," and a ",(0,t.jsx)(n.code,{children:"Service"})," to run and expose the ",(0,t.jsx)(n.code,{children:"AppRouter"}),".\nBelow are two examples for an ",(0,t.jsx)(n.code,{children:"AppRouter"}),", a ",(0,t.jsx)(n.code,{children:"Pod"}),", and a ",(0,t.jsx)(n.code,{children:"Service"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["First the ",(0,t.jsx)(n.code,{children:"Deployment"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: approuter\n  labels:\n    app: approuter\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: approuter\n  template:\n    metadata:\n      labels:\n        app: approuter\n    spec:\n      containers:\n        - image: docker-cloudsdk.docker.repositories.sap.ondemand.com/k8s-approuter:latest\n          resources:\n            requests:\n              memory: '256Mi'\n              cpu: '250m'\n            limits:\n              memory: '512Mi'\n              cpu: '500m'\n          name: approuter\n          volumeMounts:\n            - name: xsuaa-volume\n              mountPath: '/etc/secrets/sapcp/xsuaa/operator-xsuaa-service'\n              readOnly: true\n          env:\n            - name: PORT\n              value: '5000'\n            - name: destinations\n              value: '[{\"name\":\"backend\", \"url\":\"http://sdkjs-e2e-svc:8080/\", \"forwardAuthToken\": true}]'\n      imagePullSecrets:\n        - name: regcred\n      volumes:\n        - name: xsuaa-volume\n          secret:\n            secretName: operator-xsuaa-service\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You can see that we mount the XSUAA service the same way we do for apps using the SAP Cloud SDK.\nNotice the way we reference the application running in our cluster.\nInstead of an ",(0,t.jsx)(n.code,{children:"Ingress"})," endpoint we directly point at the ",(0,t.jsx)(n.code,{children:"Service"}),".\nThis is possible because the ",(0,t.jsx)(n.code,{children:"AppRouter"})," runs in our cluster and can therefore use the Kubernetes native ",(0,t.jsx)(n.code,{children:"Service"})," discovery."]}),"\n",(0,t.jsxs)(n.p,{children:["And the ",(0,t.jsx)(n.code,{children:"Service"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: approuter-svc\n  labels:\n    app: approuter\nspec:\n  ports:\n    - port: 8080\n      targetPort: 5000\n  selector:\n    app: approuter\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Finally, configure the ",(0,t.jsx)(n.code,{children:"Ingress"})," to create a session cookie that is consumed by the ",(0,t.jsx)(n.code,{children:"AppRouter"})," and point it at the ",(0,t.jsx)(n.code,{children:"AppRouter"})," service.\nTo secure your application, remove all previous routes that pointed at your application's endpoints and only expose them through the ",(0,t.jsx)(n.code,{children:"AppRouter"}),".\nThis way only users authenticated by your Identity Provider can access these endpoints.\nFor that, specify the service names in your approuter destinations' configuration and remove the rules you previously created for these endpoints in the ",(0,t.jsx)(n.code,{children:"Ingress"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Depending on your ",(0,t.jsx)(n.code,{children:"Ingress"})," controller you have to use different annotations.\nFor the NGINX Ingress controller use the following annotations:"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"nginx.ingress.kubernetes.io/affinity: cookie\nnginx.ingress.kubernetes.io/proxy-read-timeout: '600'\nnginx.ingress.kubernetes.io/session-cookie-name: JSESSIONID\n"})}),"\n",(0,t.jsxs)(n.p,{children:["A complete example of an ",(0,t.jsx)(n.code,{children:"Ingress"})," that only exposes the ",(0,t.jsx)(n.code,{children:"AppRouter"})," and is using the annotations is shown in the following example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: sdkjs-e2e-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/affinity: 'cookie'\n    nginx.ingress.kubernetes.io/proxy-read-timeout: '600'\n    nginx.ingress.kubernetes.io/session-cookie-name: 'JSESSIONID'\n    cert.gardener.cloud/purpose: managed\nspec:\n  tls:\n    - hosts:\n        - cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n        - connectivitytunnel.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      secretName: secret-tls\n  rules:\n    - host: e2e.ingress.cloud-sdk-js.sdktests.shoot.canary.k8s-hana.ondemand.com\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: approuter-svc\n                port:\n                  number: 8080\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsxs)(n.li,{children:["Be aware that just like in SAP BTP CloudFoundry, you have to collect the principal's ",(0,t.jsx)(n.code,{children:"JWT"})," from the authentication header after executing one of the requests with our typed client libraries.\nHere is an example utilizing our ",(0,t.jsx)(n.code,{children:"retrieveJwt"})," function:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"import { Injectable } from '@nestjs/common';\nimport { BusinessPartner } from '@sap/cloud-sdk-vdm-business-partner-service';\nimport { retrieveJwt } from '@sap-cloud-sdk/core';\nimport { Request } from 'express';\n\n@Injectable()\nexport class PrincipalBusinessPartnerService {\n  async getFiveBusinessPartners(request: Request): Promise<BusinessPartner[]> {\n    return BusinessPartner.requestBuilder()\n      .getAll()\n      .top(5)\n      .execute({\n        destinationName: 'MY-DESTINATION',\n        jwt: retrieveJwt(request)\n      });\n  }\n}\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(96540);const i={},r=t.createContext(i);function a(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);