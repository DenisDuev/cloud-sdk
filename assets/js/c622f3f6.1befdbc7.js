"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[1641],{63432:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>r,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>d});var n=i(74848),c=i(28453);const s={id:"mtls",title:"Certificate-Based Authentication Using SAP Cloud SDK",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Certificate-based Authentication",description:"This article describes how the SAP Cloud SDK for Java can be used to establish connections to other cloud services using mTLS",keywords:["sap","cloud","sdk","mTLS","java","connectivity"]},o=void 0,a={id:"features/connectivity/mtls",title:"Certificate-Based Authentication Using SAP Cloud SDK",description:"This article describes how the SAP Cloud SDK for Java can be used to establish connections to other cloud services using mTLS",source:"@site/docs-java_versioned_docs/version-v4/features/connectivity/mtls.mdx",sourceDirName:"features/connectivity",slug:"/features/connectivity/mtls",permalink:"/cloud-sdk/docs/java/v4/features/connectivity/mtls",draft:!1,unlisted:!1,editUrl:"https://github.com/SAP/cloud-sdk/edit/main/docs-java_versioned_docs/version-v4/features/connectivity/mtls.mdx",tags:[],version:"v4",frontMatter:{id:"mtls",title:"Certificate-Based Authentication Using SAP Cloud SDK",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Certificate-based Authentication",description:"This article describes how the SAP Cloud SDK for Java can be used to establish connections to other cloud services using mTLS",keywords:["sap","cloud","sdk","mTLS","java","connectivity"]},sidebar:"docsJavaSidebar",previous:{title:"HttpClient",permalink:"/cloud-sdk/docs/java/v4/features/connectivity/http-client"},next:{title:"Thread Context",permalink:"/cloud-sdk/docs/java/v4/features/multi-tenancy/thread-context"}},r={},d=[{value:"Why Certificate-Based Authentication (mTLS)",id:"why-certificate-based-authentication-mtls",level:2},{value:"Shortcomings of Using Secret for Token Retrieval",id:"shortcomings-of-using-secret-for-token-retrieval",level:2},{value:"Certificate-Based Authentication for Services",id:"certificate-based-authentication-for-services",level:2},{value:"Default Validity Period of Certificates",id:"default-validity-period-of-certificates",level:2},{value:"Extending the Validity of a Certificate",id:"extending-the-validity-of-a-certificate",level:3},{value:"Sticking to Using Secret for Token Retrieval",id:"sticking-to-using-secret-for-token-retrieval",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["This article talks about using mTLS to connect with cloud services like ",(0,n.jsx)(t.code,{children:"XSUAA"})," or ",(0,n.jsx)(t.code,{children:"Destination"})," service.\nIf you are interested in using mTLS for communication between your application and target destination, please refer ",(0,n.jsx)(t.a,{href:"/cloud-sdk/docs/java/features/connectivity/destination-service#enabling-mtls-for-application-to-destination-communication",children:"here"})," instead."]})}),"\n",(0,n.jsxs)(t.p,{children:["The SAP Cloud SDK supports certificate-based authentication while establishing connections to other cloud services like ",(0,n.jsx)(t.code,{children:"XSUAA"})," or ",(0,n.jsx)(t.code,{children:"Destination"})," service."]}),"\n",(0,n.jsx)(t.h2,{id:"why-certificate-based-authentication-mtls",children:"Why Certificate-Based Authentication (mTLS)"}),"\n",(0,n.jsxs)(t.p,{children:["Mutual ",(0,n.jsx)(t.code,{children:"TLS"})," or ",(0,n.jsx)(t.code,{children:"mTLS"})," for short is a method for mutual authentication.\nIt ensures that before proceeding with the ",(0,n.jsx)(t.code,{children:"HTTP"})," exchange both the client and the server each mutually verify each other's identities by the use of ",(0,n.jsx)(t.code,{children:"X.509"})," certificates.\nUsing certificate-based authentication ensures overcoming the shortcomings of authenticating with ",(0,n.jsx)(t.code,{children:"clientsecret"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"shortcomings-of-using-secret-for-token-retrieval",children:"Shortcomings of Using Secret for Token Retrieval"}),"\n",(0,n.jsxs)(t.p,{children:["Let's take an example of a service or an application protected by ",(0,n.jsx)(t.a,{href:"https://help.sap.com/viewer/65de2977205c403bbc107264b8eccf4b/Cloud/en-US/6373bb7a96114d619bfdfdc6f505d1b9.html",children:(0,n.jsx)(t.code,{children:"XSUAA"})}),".\nTo access the service or application, you'll need a ",(0,n.jsx)(t.code,{children:"JWT"}),".\nYou will usually fetch a ",(0,n.jsx)(t.code,{children:"JWT"})," by providing ",(0,n.jsx)(t.code,{children:"clientid"}),", ",(0,n.jsx)(t.code,{children:"clientsecret"})," and ",(0,n.jsx)(t.code,{children:"uri"})," stored in your service binding to run a ",(0,n.jsx)(t.a,{href:"https://github.com/SAP/cloud-security-xsuaa-integration/tree/main/token-client",children:(0,n.jsx)(t.code,{children:"token retrieval flow"})})," say for e.g. ",(0,n.jsx)(t.code,{children:"client"})]}),"\n",(0,n.jsxs)(t.p,{children:["The use of ",(0,n.jsx)(t.code,{children:"clientsecret"})," has an inherent risk of these credentials being leaked, especially as they are not frequently rotated.\nLeaking these credentials into the hands of an attacker can cause a lot of harm and stay long unnoticed.\nThe use of certificate-based authentication to fetch the ",(0,n.jsx)(t.code,{children:"JWT"})," from ",(0,n.jsx)(t.code,{children:"XSUAA"})," significantly reduces the risk of leaking secrets and makes rotating them easier."]}),"\n",(0,n.jsxs)(t.admonition,{type:"note",children:[(0,n.jsx)(t.p,{children:"The SAP Cloud SDK automatically"}),(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Fetches the ",(0,n.jsx)(t.code,{children:"JWT"})," for you"]}),"\n",(0,n.jsxs)(t.li,{children:["Adds the fetched ",(0,n.jsx)(t.code,{children:"JWT"})," to the ",(0,n.jsx)(t.code,{children:"Authorization"})," header when requesting a service to ensure that the request gets authenticated and authorized."]}),"\n"]}),(0,n.jsx)(t.p,{children:"Application developers do not need to worry about doing any of this themselves."})]}),"\n",(0,n.jsx)(t.h2,{id:"certificate-based-authentication-for-services",children:"Certificate-Based Authentication for Services"}),"\n",(0,n.jsxs)(t.p,{children:["To adhere to the latest recommended security best practices by SAP, some re-use and kernel services have enabled certificate-based authentication.\nAs a consequence, SAP Cloud SDK also supports certificate-based authentication while accessing these services.\nIf a service binding has a property ",(0,n.jsx)(t.code,{children:"credentials: { credential-type: x509 }"})," then this is an indication that you can use certificate-based authentication to access the service."]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"XSUAA"})," service is one of the services that has enabled certificate-based authentication.\nThis means that in the service binding in addition to the ",(0,n.jsx)(t.code,{children:"client_secret"})," you will also find ",(0,n.jsx)(t.code,{children:"certificate"})," and ",(0,n.jsx)(t.code,{children:"key"})," entries now.\nExample:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n    "VCAP_SERVICES": {\n\t\t"xsuaa": [\n\t\t\t{\n\t\t\t\t"label": "xsuaa",\n\t\t\t\t...\n\t\t\t\t"credentials": {\n\t\t\t\t    ...\n\t\t\t\t    "credential-type": "x509"\n\t\t\t\t\t"clientid": "fictional-client-id",\n\t\t\t\t\t"clientsecret": "fictional-secret",\n\t\t\t\t\t"certificate": "-----BEGIN CERTIFICATE-----fictional-certificate-----END CERTIFICATE-----\\n",\n\t\t\t\t\t"key": "key"\n\t\t\t\t\t...\n\t\t\t\t},\n\t\t\t}\n\t\t]\n\t}\n}\n'})}),"\n",(0,n.jsxs)(t.p,{children:["This certificate would now be used in place of ",(0,n.jsx)(t.code,{children:"clientsecret"})," to obtain the ",(0,n.jsx)(t.code,{children:"JWT"})," using ",(0,n.jsxs)(t.a,{href:"https://github.com/SAP/cloud-security-xsuaa-integration/tree/main/token-client",children:[(0,n.jsx)(t.code,{children:"XSUAA"})," token retrieval flows"]}),".\nThe SAP Cloud SDK will as before fetch the ",(0,n.jsx)(t.code,{children:"JWT"})," for you.\nThe only difference is that the ",(0,n.jsx)(t.code,{children:"certificate"})," from your service binding is used to authenticate the client."]}),"\n",(0,n.jsx)(t.h2,{id:"default-validity-period-of-certificates",children:"Default Validity Period of Certificates"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"X.509"})," certificates used in the service binding could either be external or ",(0,n.jsx)(t.code,{children:"XSUAA"})," managed.\nBy default ",(0,n.jsx)(t.code,{children:"XSUAA"})," managed certificates are valid only for ",(0,n.jsx)(t.strong,{children:"7 days"}),".\nYour calls to the ",(0,n.jsx)(t.code,{children:"XSUAA"})," to fetch a ",(0,n.jsx)(t.code,{children:"JWT"})," will fail after your certificate expires."]}),"\n",(0,n.jsx)(t.p,{children:"You can verify this by looking at the logs of your application, you should see"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"[APP/PROC/WEB/0] OUT Caused by: com.sap.cloud.sdk.cloudplatform.security.exception.TokenRequestFailedException:\ncom.sap.cloud.security.xsuaa.tokenflows.TokenFlowException:\nError requesting technical user token with grant_type 'client_credentials':\nError retrieving JWT token. Server URI https://<subdomain>.authentication.cert.<landscape domain>/oauth/token.\nHttp status code 400. Response body '400 Bad Request: TLS handshake failed.\n\n[APP/PROC/WEB/0] OUT ssl_c_err: X509_V_ERR_CERT_HAS_EXPIRED\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Don't get confused with the grant_type of ",(0,n.jsx)(t.code,{children:"client_credentials"})," in the log, this is expected."]}),"\n",(0,n.jsxs)(t.p,{children:["For ",(0,n.jsx)(t.code,{children:"X.509"})," certificate-based authentication, the token retrieval end point will look like\n",(0,n.jsx)(t.code,{children:"https://<subdomain>.authentication.cert.<landscape domain>/oauth/token"}),".\nNotice that the endpoint contains ",(0,n.jsx)(t.strong,{children:"cert"})," ."]}),"\n",(0,n.jsxs)(t.p,{children:["For authentication based on ",(0,n.jsx)(t.code,{children:"clientsecret"}),", the end point would have looked like: ",(0,n.jsx)(t.code,{children:"https://<subdomain>.authentication.<landscape domain>/oauth/token"})]}),"\n",(0,n.jsx)(t.admonition,{title:"certificate renewal process",type:"caution",children:(0,n.jsx)(t.p,{children:"To obtain a new certificate, you will have to delete and re-create a service binding.\nThe application also needs to be restarted to use the updated service binding."})}),"\n",(0,n.jsx)(t.h3,{id:"extending-the-validity-of-a-certificate",children:"Extending the Validity of a Certificate"}),"\n",(0,n.jsxs)(t.p,{children:["For less frequent certificate rotation you can extend its validity to a maximum of 1 year.\nFor the ",(0,n.jsx)(t.code,{children:"XSUAA"})," managed certificate use parameters below while creating a service ",(0,n.jsx)(t.strong,{children:"binding"}),"."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.code,{children:"cf bind-service myapp myservice -c parameters.json"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "credential-type": "x509",\n  "x509": {\n    "key-length": 2048,\n    "validity": 365,\n    "validity-type": "DAYS"\n  }\n}\n'})}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"With longer certificate validity there is a danger that compromised certificate might go unnoticed for a significant period of time.\nThis significantly increases potential damage to a compromised system."})}),"\n",(0,n.jsx)(t.h2,{id:"sticking-to-using-secret-for-token-retrieval",children:"Sticking to Using Secret for Token Retrieval"}),"\n",(0,n.jsxs)(t.p,{children:["If you prefer to continue using ",(0,n.jsx)(t.strong,{children:"clientSecret"})," instead of ",(0,n.jsx)(t.strong,{children:"Certificate-based Authentication"}),", make sure your ",(0,n.jsx)(t.code,{children:"xs-security.json"})," contains the ",(0,n.jsx)(t.code,{children:"instance-secret"})," as the first entry in the property ",(0,n.jsx)(t.code,{children:"credential-types"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'"oauth2-configuration": {\n  "credential-types": ["instance-secret"]\n}\n'})})]})}function h(e={}){const{wrapper:t}={...(0,c.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},28453:(e,t,i)=>{i.d(t,{R:()=>o,x:()=>a});var n=i(96540);const c={},s=n.createContext(c);function o(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:o(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);